# Secure Docker Compose Configuration for ContextForge
# Includes TLS/SSL, secrets management, non-root containers, and resource limits

# Docker secrets for sensitive data
secrets:
  jwt_secret:
    file: ./secrets/jwt_secret.txt
  csrf_secret:
    file: ./secrets/csrf_secret.txt
  db_password:
    file: ./secrets/db_password.txt
  redis_password:
    file: ./secrets/redis_password.txt
  openai_api_key:
    file: ./secrets/openai_api_key.txt
  anthropic_api_key:
    file: ./secrets/anthropic_api_key.txt
  encryption_key:
    file: ./secrets/encryption_key.txt
  tls_cert:
    file: ./certs/server.crt
  tls_key:
    file: ./certs/server.key

services:
  api_gateway:
    build:
      context: .
      dockerfile: services/api_gateway/Dockerfile
    ports:
      - "8443:8443"  # HTTPS
    environment:
      # Service URLs
      - VECTOR_INDEX_URL=http://vector-index:8001
      - PREPROCESSOR_URL=http://preprocessor:8003
      - CONNECTOR_URL=http://connector:8002
      - WEB_FETCHER_URL=http://web-fetcher:8004
      - TERMINAL_EXECUTOR_URL=http://terminal-executor:8006
      
      # LLM URLs (non-sensitive)
      - OLLAMA_URL=${OLLAMA_URL:-http://host.docker.internal:11434/api/generate}
      - LM_STUDIO_URL=${LM_STUDIO_URL:-http://host.docker.internal:8085/generate}
      - LLM_PRIORITY=${LLM_PRIORITY:-ollama}
      
      # Security settings
      - ENABLE_SECURITY_HEADERS=true
      - ENABLE_HSTS=true
      - RATE_LIMIT_ENABLED=true
      - AUDIT_LOG_ENABLED=true
      - USE_REDIS_RATE_LIMIT=true
      - REDIS_URL=redis://:run/secrets/redis_password@redis:6379/0
      
      # TLS/SSL
      - TLS_ENABLED=true
      - TLS_CERT_PATH=/run/secrets/tls_cert
      - TLS_KEY_PATH=/run/secrets/tls_key
      
      # Max request size (10 MB)
      - MAX_REQUEST_SIZE=10485760
      
      # Log level
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    
    secrets:
      - jwt_secret
      - csrf_secret
      - openai_api_key
      - anthropic_api_key
      - encryption_key
      - source: tls_cert
        target: /run/secrets/tls_cert
      - source: tls_key
        target: /run/secrets/tls_key
    
    volumes:
      - ./data:/app/data:ro  # Read-only data mount
      - ./logs:/app/logs
    
    depends_on:
      - vector-index
      - preprocessor
      - connector
      - web-fetcher
      - terminal-executor
      - redis
    
    networks:
      - contextforge
    
    # Security: Run as non-root user
    user: "1000:1000"
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    
    # Security options
    security_opt:
      - no-new-privileges:true
    
    cap_drop:
      - ALL
    
    cap_add:
      - NET_BIND_SERVICE  # For binding to port 443
    
    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "-k", "https://localhost:8443/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  vector-index:
    build:
      context: .
      dockerfile: services/vector_index/Dockerfile
    ports:
      - "8001:8001"
    environment:
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-all-mpnet-base-v2}
      - CODE_EMBEDDING_MODEL=${CODE_EMBEDDING_MODEL:-microsoft/codebert-base}
      - USE_CODE_EMBEDDINGS=${USE_CODE_EMBEDDINGS:-true}
      - HYBRID_SEARCH_ENABLED=${HYBRID_SEARCH_ENABLED:-true}
      - DENSE_WEIGHT=${DENSE_WEIGHT:-0.7}
      - LEXICAL_WEIGHT=${LEXICAL_WEIGHT:-0.3}
      - RECENCY_BOOST_ENABLED=${RECENCY_BOOST_ENABLED:-true}
      - RECENCY_BOOST_FACTOR=${RECENCY_BOOST_FACTOR:-0.1}
    
    volumes:
      - ./data/vector_index:/app/data
    
    networks:
      - contextforge
    
    user: "1000:1000"
    
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 1G
    
    security_opt:
      - no-new-privileges:true
    
    cap_drop:
      - ALL

  preprocessor:
    build:
      context: .
      dockerfile: services/preprocessor/Dockerfile
    ports:
      - "8003:8003"
    environment:
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - MIN_CHUNK_SIZE=${MIN_CHUNK_SIZE:-512}
      - MAX_CHUNK_SIZE=${MAX_CHUNK_SIZE:-4096}
      - DEFAULT_CHUNK_SIZE=${DEFAULT_CHUNK_SIZE:-2048}
      - CHUNK_OVERLAP=${CHUNK_OVERLAP:-200}

    networks:
      - contextforge

    user: "1000:1000"

    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G

    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

  connector:
    build:
      context: .
      dockerfile: services/connector/Dockerfile
    ports:
      - "8002:8002"
    environment:
      - LOG_LEVEL=${LOG_LEVEL:-INFO}

    volumes:
      - ./data/repos:/app/repos:ro

    networks:
      - contextforge

    user: "1000:1000"

    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G

    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

  web-fetcher:
    build:
      context: .
      dockerfile: services/web_fetcher/Dockerfile
    ports:
      - "8004:8004"
    environment:
      - LOG_LEVEL=${LOG_LEVEL:-INFO}

    volumes:
      - ./data/web_cache:/app/cache

    networks:
      - contextforge

    user: "1000:1000"

    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

  terminal-executor:
    build:
      context: .
      dockerfile: services/terminal_executor/Dockerfile
    ports:
      - "8006:8006"
    environment:
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - COMMAND_WHITELIST_ENABLED=true
      - SANDBOX_ENABLED=true
      - MAX_CONCURRENT_PROCESSES=5

    volumes:
      - ./data/repos:/app/workspace:ro  # Read-only workspace

    networks:
      - contextforge

    user: "1000:1000"

    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G

    security_opt:
      - no-new-privileges:true

    cap_drop:
      - ALL

    # No Docker socket access for security

  # Redis with password authentication
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

    command: >
      sh -c "redis-server
      --requirepass $$(cat /run/secrets/redis_password)
      --appendonly yes
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru"

    secrets:
      - redis_password

    volumes:
      - redis_data:/data

    networks:
      - contextforge

    user: "999:999"  # Redis user

    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

    security_opt:
      - no-new-privileges:true

    cap_drop:
      - ALL

    healthcheck:
      test: ["CMD", "redis-cli", "--no-auth-warning", "-a", "$$(cat /run/secrets/redis_password)", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL with secrets
  postgres:
    image: postgres:15-alpine
    ports:
      - "5432:5432"

    environment:
      - POSTGRES_USER=contextforge
      - POSTGRES_PASSWORD_FILE=/run/secrets/db_password
      - POSTGRES_DB=contextforge
      - POSTGRES_INITDB_ARGS=--auth-host=scram-sha-256

    secrets:
      - db_password

    volumes:
      - postgres_data:/var/lib/postgresql/data

    networks:
      - contextforge

    user: "999:999"  # Postgres user

    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G

    security_opt:
      - no-new-privileges:true

    cap_drop:
      - ALL

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U contextforge"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Persistence Service
  persistence:
    build:
      context: .
      dockerfile: services/persistence/Dockerfile
    ports:
      - "8015:8010"

    environment:
      - USE_POSTGRES=true
      - DATABASE_URL=postgresql://contextforge:$$(cat /run/secrets/db_password)@postgres:5432/contextforge
      - LOG_LEVEL=${LOG_LEVEL:-INFO}

    secrets:
      - db_password

    depends_on:
      - postgres

    networks:
      - contextforge

    user: "1000:1000"

    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

    security_opt:
      - no-new-privileges:true

    cap_drop:
      - ALL

volumes:
  redis_data:
  postgres_data:

networks:
  contextforge:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

